# 4399游戏盒h5小游戏接入文档

## 修改记录

版本号  |   修改日期    |   修改者  |   修改内容
--------|---------------|-----------|-------------------------
v1.0.0  |   2018-7-23  |   黄家强    |   创建文档


## 1 业务介绍

### 1.1 主要功能
4399游戏盒h5小游戏小游戏平台当前具备基本的账号、基本用户信息、游戏充值的功能，通过提供给小游戏方js接口和服务端接口来实现这些功能。

## 2 接入步骤
### 2.1 申请gameId, secret
### 2.2 安装4399游戏盒进行接口对接调试
1、引入js文件

2、初始化
```javascript
  gb4399.init({
      gameId: 'com.xxxx.4399gamebox',  　　
      dev: '1'　　　　　　　　//开发状态　1，　发布状态　0
  })
```

3、退出游戏
```javascript
  gb4399.exit() 
```

[4. 其他接口详见js接口文档](#接口文档)   

### 2.3、 测试－提审－发布

## 3 <span id="接口文档">接口文档</span>


### 3.1　帐号相关


#### 3.1.1　登录 (该接口由前端提供)

调用js接口gb4399.login(OBJECT) 获取临时登录凭证（accessToke）
```javascript
  gb4399.login({
      success: function(res) {
        res.accessToke  //临时登录凭证
      },
      fail: function(res)
      {
          res.code //失败状态码
          res.msg  //错误信息描述
      }
    });
```
#### 3.1.2 登录凭证校验(服务端接口－需服务端提供详细文档)

开发者服务器使用，用于通过临时登录凭证accessToke 获取 session_key 和 openid 等。

接口地址：
```
https://www.xxx.xxx/xxx/sessionexchage?accessToken=xxx
```

### 3.2 充值相关

#### 3.2.1 充值接口

调用js接口gb4399.recharge(OBJECT) 进行充值
```javascript
gb4399.recharge({
   serverId:0,   // 角色所在区服，若无区服可传“0”
   gameName:'lianliankan', //游戏名
   gameUnion:'34532',   //4399充值中心为H5游戏分配的id
   commodity:'盒币',   //商品名
   money:9999,        //充值数量
   mark:'ewqf32gfds'   //游戏方订单号
   supportExcess:1,   //是否允许重新调整充值数量，在充值页中重选金额　1允许　0不允许
   extra:'extra',    //扩展字段
   description:'相关描述'，　　
   
   success: function(res) {
        res.money  //充值成功数量
        res.msg    //
      },
　fail: function(res) {
        res.code  //错误码
        res.msg    //错误描述
      },
});
```

####  3.2.2 充值接口回调（服务端接口）
##### 接口说明
用户充值成功后，SDK服务端将充值信息回调到游戏方服务端，游戏方服务端应在5秒内返回充值结果，否则将判定订单为异常订单。 只有确认订单是失败的情况下，才返回失败的返回值，当充值中心收到失败的返回值时，将退还用户的充值金额到游币账户，此后若该笔订单在游戏里又处理成充值成功，将造成充值金额的损失。
##### 接口定义
- 接口名称：充值回调接口
- 接口描述：用户充值时，手机平台将请求本接口通知游戏方进行充值
- 接口协议：GET
- 接口开发：游戏方
##### 请求参数
   字段    |   必填    |   数据类型    |   说明    
-----------|-----------|---------------|-----------
orderid | 是|string|(4399生成的订单号) 22位以内的字符串 唯一
p_type|是|int|充值渠道id
uid|是|unsigned int|要充值的用户ID，my平台的用户uid 
money|是|int|用户充值的人民币金额，单位：元 
gamemoney|是|int|兑换的游戏币数量，兑换标准由双方共同约定，若在标准兑换比率基础上，有一些优惠或者赠送策略，可无视此数据，由应用端自行计算实际的兑换数额
serverid|否|int|要充值的服务区号。只针对有分服的游戏有效。参数的格式为：区服id。 例如 1服 为 1,  11服为 11
mark|否|string|作为预留字段，部分游戏在游戏内发起充值时，会生成唯一标识来标注该笔充值的相关信息时，可以用本字段。（游戏方生成的订单号）
roleid|否|int|要充值的游戏角色id，只针对pc端充值时，需要选择游戏角色的游戏有效。roleid的值由角色接口提供（见接口2）
time|是|int|发起请求时的时间戳
coupon_mark|否|String|优惠券的唯一标识
coupon_money|否|int|优惠券的金额
sign|是|string|加密签名，签名计算为：`$sign` = md5(`$orderid` . `$uid` . `$money` . `$gamemoney` . `$serverid` . `$secrect` . `$mark` . `$roleid`.`$time`.`$coupon_mark`.`$coupon_money`); 当参数`$serverid`,`$mark` ,`$roleid`,`$coupon_mark`,`$coupon_money`为空时，不参与签名计算。详见[签名说明](#签名说明)。

##### 返回结果
```json
{
    "status":2,
    "code":null,
    "money":"1",
    "game_money":"10",
    "msg":"充值成功"
}
```

参数名| 说明  
-------|-----
status |`1`：异常；<BR/>`2`：成功；<BR/>`3`：失败（将钱返还给用户）
code|异常状态码，成功或失败为空。<BR/>`sign_error`:请求串的md5验证码错误<BR/>`user_not_exist`:用户账号不存在<BR/>`orderid_exist`:订单已提交（提交订单号必须唯一)<BR/>`money_error`:充值金额或兑换游戏币数量错误，充值金额为正整数，需符合双方约定的兑换标准<BR/>`other_error`:其他错误
money|用户充值的人民币金额，单位：元 
gamemoney|用户实际兑换的游戏币的数量  
msg|开发商自定义的内容（返回结果的说明等）


#### 订单信息查询接口
##### 接口定义
- 接口名称：订单信息查询接口
- 接口描述：根据订单号，获取订单信息
- 接口协议：GET
- 接口开发：游戏方

##### 请求参数
   字段    |   必填    |   数据类型    |   说明    
-----------|-----------|---------------|-----------
order   |   是  |   string  |   订单号
time    |   是  |   int     |   发起请求时的时间戳
serverid|   否  |   int     |   充值对应的服务器id，如果不需要该参数或者无服务器概念的游戏，可无视
flag    |   是  |   string  |   加密签名，签名计算为：`$flag` = md5(`$order` . `$time` . `$secrect`);详见[签名说明](#签名说明)。  


##### 返回结果
```json
若订单正确将返回JSON格式订单数据
{
    "order":"1313164",
    "uid":"123456",
    "money":"2234",
    "gamemoney":"1234",
    "time":"2012-12-25 07:59:59",
    "nickname":"\u6ef4\u6ef4",
    "serve_id":"1",
    "status":"1"
}

若订单错误则返回错误代码例如：
-1
```

 

参数名| 说明
-------|-----
order|订单号
uid|即4399的用户`uid`
money|用户充值的人民币金额，单位：元 
gamemoney|游戏币
time|充值的时间，格式：`YYYY-mm-dd HH:ii:ss`
nickname|用户在游戏中的角色名
server_id|充值的游戏服务器id
status|订单状态:<br/>`“1”`：成功 <br/>`“-1”`：失败，充值金额将返还给玩家 <br/> `“0”`：异常，需要人工确认

错误代码    |   说明    
------------|-----------
-1          |订单信息不存在
0           |未知错误
1           |参数错误
2           |验证错误

##### 签名说明
1. 参与签名的所有参数为接受到的原始参数，请不要在参与签名计算前对参数做任何处理  
2. 使用标准`MD5`算法对该字符串加密  
3. `$secrect` 为4399自动分配的密钥，仅可用于服务端，请勿将其写入客户端代码中。

